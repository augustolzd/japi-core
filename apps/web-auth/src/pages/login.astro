---
// biome-ignore lint/correctness/noUnusedImports: false positive in astro
import { LoginForm } from '../components/LoginForm';
// biome-ignore lint/correctness/noUnusedImports: false positive in astro
import Layout from '../layouts/Layout.astro';
import '@japi/ui-system/styles/variables.css';

import * as jose from 'jose';

const JWT_SECRET = new TextEncoder().encode(process.env.JWT_SECRET || 'auth-service-secret-key');
const token = Astro.cookies.get('japi_token')?.value;
const returnTo = Astro.url.searchParams.get('returnTo') || 'http://localhost:4322';

// Anti-Cache
Astro.response.headers.set('Cache-Control', 'no-store, no-cache, must-revalidate');
Astro.response.headers.set('Pragma', 'no-cache');
Astro.response.headers.set('Expires', '0');

if (token) {
  try {
    await jose.jwtVerify(token, JWT_SECRET);
    // Token is valid, redirect back
    const redirectUrl = new URL(returnTo);
    redirectUrl.searchParams.set('token', token);
    return Astro.redirect(redirectUrl.toString());
  } catch (_e) {
    // Token invalid or expired, continue to login page
    Astro.cookies.delete('japi_token', { path: '/' });
  }
}
---

<Layout title="Iniciar Sesión - Japi Auth">
  <main>
    <section class="auth-wrapper">
      <LoginForm client:load />
      <p class="register-link">
        ¿No tienes cuenta? <a href="/register">Regístrate aquí</a>
      </p>
    </section>
  </main>
</Layout>

<style>
  .auth-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: var(--japi-spacing-4);
  }
  
  .register-link {
    margin-top: var(--japi-spacing-4);
    font-size: 0.875rem;
    color: var(--japi-color-neutral-600);
  }
  
  .register-link a {
    color: var(--japi-color-primary-600);
    text-decoration: none;
    font-weight: 600;
  }
  
  .register-link a:hover {
    text-decoration: underline;
  }
</style>

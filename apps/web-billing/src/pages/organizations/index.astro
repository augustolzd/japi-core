---
import BillingLayout from '../../layouts/BillingLayout.astro';
import { Button } from '@japi/ui-system';
import { PrismaClient } from '@japi/database';

const prisma = new PrismaClient();
const { user } = Astro.locals;

const organizations = await prisma.organization.findMany({
  include: {
    serviceProvider: true,
    _count: {
      select: { costCenters: true, users: true },
    },
  },
  orderBy: { name: 'asc' },
});
---

<BillingLayout title="Organizaciones" userEmail={user?.email as string}>
  <div class="card">
    <div class="table-header">
      <p>Nivel 2: Entidades legales (Tenants) asignadas a un Proveedor.</p>
      <a href="/organizations/new">
        <Button variant="primary">+ Nueva Organizaci√≥n</Button>
      </a>
    </div>
    
    <table class="japi-table">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>RFC / Tax ID</th>
          <th>Proveedor</th>
          <th>Unidades (CC)</th>
          <th>Usuarios</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {organizations.map(org => (
          <tr>
            <td><strong>{org.name}</strong></td>
            <td><code>{org.taxId}</code></td>
            <td><span class="badge">{org.serviceProvider.name}</span></td>
            <td>{org._count.costCenters}</td>
            <td>{org._count.users}</td>
            <td>
              <Button variant="secondary">Gestionar</Button>
            </td>
          </tr>
        ))}
      </tbody>
    </table>
  </div>
</BillingLayout>

<style>
  .table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--japi-spacing-6);
  }
  .table-header p {
    color: var(--japi-color-neutral-500);
    margin: 0;
  }
  .japi-table {
    width: 100%;
    border-collapse: collapse;
    text-align: left;
  }
  .japi-table th {
    padding: var(--japi-spacing-4);
    border-bottom: 2px solid var(--japi-color-neutral-100);
    color: var(--japi-color-neutral-500);
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .japi-table td {
    padding: var(--japi-spacing-4);
    border-bottom: 1px solid var(--japi-color-neutral-100);
    font-size: 0.9375rem;
  }
  .badge {
    background: var(--japi-color-neutral-100);
    padding: var(--japi-spacing-1) var(--japi-spacing-2);
    border-radius: var(--japi-radius-full);
    font-size: 0.75rem;
    font-weight: 600;
  }
</style>

---
import { Button } from '@japi/ui-system';
import '@japi/ui-system/styles/variables.css';
const { user: admin } = Astro.locals;
---

<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Admin Dashboard - Japi</title>
</head>
<body class="japi-body">
  <main class="page-container">
    <header class="header">
      <h1 class="title">Japi IAM Console</h1>
      <div class="user-status">
        {admin ? (
          <div class="user-info">
            <span class="user-name">{admin.firstName} ({admin.role})</span>
            <button id="logout-btn" class="logout-link">Salir</button>
          </div>
        ) : (
          <span class="status-badge">Sin Sesión</span>
        )}
      </div>
    </header>

    <section class="admin-hero">
      {admin ? (
        <div class="admin-dashboard">
          <h2>Controlador de IAM</h2>
          <div class="admin-grid">
            <div class="admin-card">
              <h3>Usuarios y Grupos</h3>
              <p>Gestionar acceso programado y asignación de roles.</p>
              <Button variant="secondary">Usuarios</Button>
            </div>
            <div class="admin-card">
              <h3>Políticas de Seguridad</h3>
              <p>Configurar ACLs y permisos por jerarquía.</p>
              <Button variant="secondary">Editar Políticas</Button>
            </div>
          </div>
        </div>
      ) : (
        <>
          <h2>Consola de Control de Acceso</h2>
          <p>Gestión centralizada de identidades, roles y permisos de Japi Core.</p>
          
          <div class="actions">
            <a href="http://localhost:4323/login?returnTo=http://localhost:4325">
              <Button variant="primary">Iniciar Sesión de Seguridad</Button>
            </a>
          </div>
        </>
      )}
    </section>
  </main>

  <script>
    // Session Guardian: Evita loops de 401
    async function checkSession() {
      const token = document.cookie.split('; ').find(row => row.startsWith('japi_token='))?.split('=')[1];
      if (!token) return;

      try {
        const response = await fetch('http://localhost:4323/api/verify-session', {
          credentials: 'include'
        });

        if (!response.ok) {
          console.warn('Master session invalid, cleaning up...');
          // Cleanup
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i];
            const eqPos = cookie.indexOf("=");
            const name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();
            document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
            document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=" + window.location.hostname;
          }
          window.location.href = 'http://localhost:4323/login?returnTo=' + encodeURIComponent(window.location.href);
        }
      } catch (err) {
        console.error('Guardian check failed:', err);
      }
    }

    checkSession();
    window.addEventListener('pageshow', (event) => {
      if (event.persisted) checkSession();
    });

    document.getElementById('logout-btn')?.addEventListener('click', (e) => {
      e.preventDefault();
      // Total local cleanup
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i];
        const eqPos = cookie.indexOf("=");
        const name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();
        document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
        document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=" + window.location.hostname;
      }
      window.location.href = 'http://localhost:4323/logout?returnTo=http://localhost:4325';
    });
  </script>
</body>

</html>

<style>
  :root {
    font-family: 'Inter', system-ui, sans-serif;
  }
  .japi-body {
    background-color: var(--japi-color-neutral-50);
    margin: 0;
    color: var(--japi-color-neutral-900);
  }
  .page-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--japi-spacing-8);
  }
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--japi-spacing-12);
  }
  .title {
    font-size: 2rem;
    font-weight: 800;
    color: var(--japi-color-neutral-900);
  }
  .admin-hero {
    text-align: center;
    padding: var(--japi-spacing-12) var(--japi-spacing-4);
    background: var(--japi-color-neutral-0);
    border-radius: var(--japi-radius-xl);
    border: 1px solid var(--japi-color-neutral-200);
    box-shadow: var(--japi-shadow-lg);
  }
  .actions {
    margin-top: var(--japi-spacing-8);
  }
  .status-badge {
    background-color: var(--japi-color-warning);
    color: var(--japi-color-neutral-950);
    padding: var(--japi-spacing-1) var(--japi-spacing-3);
    border-radius: var(--japi-radius-full);
    font-size: 0.75rem;
    font-weight: 600;
  }

  .user-info {
    display: flex;
    align-items: center;
    gap: var(--japi-spacing-4);
  }

  .user-name {
    font-weight: 600;
    color: var(--japi-color-neutral-700);
  }

  .logout-link {
    background: none;
    border: none;
    color: var(--japi-color-error);
    font-size: 0.875rem;
    cursor: pointer;
    text-decoration: underline;
    padding: 0;
  }

  .admin-dashboard {
    text-align: left;
    max-width: 900px;
    margin: 0 auto;
  }

  .admin-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--japi-spacing-6);
    margin-top: var(--japi-spacing-8);
  }

  .admin-card {
    background: var(--japi-color-neutral-50);
    padding: var(--japi-spacing-6);
    border-radius: var(--japi-radius-xl);
    border: 1px solid var(--japi-color-neutral-200);
    transition: transform 0.2s;
  }

  .admin-card:hover {
    transform: translateY(-4px);
  }

  .admin-card h3 {
    margin-top: 0;
    color: var(--japi-color-primary-700);
  }

  .admin-card p {
    color: var(--japi-color-neutral-600);
    font-size: 0.875rem;
    margin-bottom: var(--japi-spacing-6);
  }
  
  @media (prefers-color-scheme: dark) {
    .japi-body {
      background-color: var(--japi-color-neutral-950);
      color: var(--japi-color-neutral-100);
    }
    .admin-hero {
      background: var(--japi-color-neutral-900);
      border-color: var(--japi-color-neutral-800);
    }
    .title {
      color: var(--japi-color-neutral-0);
    }
    .user-name {
      color: var(--japi-color-neutral-300);
    }
    .admin-card {
      background: var(--japi-color-neutral-800);
      border-color: var(--japi-color-neutral-700);
    }
    .admin-card h3 {
      color: var(--japi-color-primary-400);
    }
    .admin-card p {
      color: var(--japi-color-neutral-400);
    }
  }
</style>

